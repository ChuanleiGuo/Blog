<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"chuanleiguo.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"hide","padding":18,"offset":12,"onmobile":true},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="SwiftyJSON 是使用Swift编写的 JSON 解析库。Swift 是一门强类型的语言，并且引入了 Optional 类型。这使得解析 JSON 数据变得异常麻烦，我们往往需要不断地判断 Optional 中是否包含了有效值： 12345678910let jsonObject : AnyObject! &#x3D; NSJSONSerialization.JSONObjectWithData(da">
<meta property="og:type" content="article">
<meta property="og:title" content="SwiftyJSON 源码阅读笔记">
<meta property="og:url" content="http://chuanleiguo.com/2016/07/09/SwiftyJSON%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="Chuan&#39;s Cabin">
<meta property="og:description" content="SwiftyJSON 是使用Swift编写的 JSON 解析库。Swift 是一门强类型的语言，并且引入了 Optional 类型。这使得解析 JSON 数据变得异常麻烦，我们往往需要不断地判断 Optional 中是否包含了有效值： 12345678910let jsonObject : AnyObject! &#x3D; NSJSONSerialization.JSONObjectWithData(da">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://chuanleiguo.com/images/2016-7-10/image.001.jpeg">
<meta property="article:published_time" content="2016-07-09T18:18:23.000Z">
<meta property="article:modified_time" content="2020-06-21T10:55:55.495Z">
<meta property="article:author" content="Chuanlei Guo">
<meta property="article:tag" content="swift">
<meta property="article:tag" content="sourcecode">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://chuanleiguo.com/images/2016-7-10/image.001.jpeg">

<link rel="canonical" href="http://chuanleiguo.com/2016/07/09/SwiftyJSON%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>SwiftyJSON 源码阅读笔记 | Chuan's Cabin</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"] > svg a {
  fill: blue;
  stroke: blue;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container {
  overflow: auto hidden;
}

mjx-container + br {
  display: none;
}
</style></head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Chuan's Cabin</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Code & Live with Love</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-programming-language">

    <a href="/categories/programming-language" rel="section"><i class="fa fa-rocket fa-fw"></i>编程语言</a>

  </li>
        <li class="menu-item menu-item-sourcecode">

    <a href="/categories/sourcecode" rel="section"><i class="fa fa-code fa-fw"></i>源码分析</a>

  </li>
        <li class="menu-item menu-item-computer-science">

    <a href="/categories/computer-science" rel="section"><i class="fa fa-cogs fa-fw"></i>计算机科学</a>

  </li>
        <li class="menu-item menu-item-mooc">

    <a href="/categories/mooc" rel="section"><i class="fa fa-graduation-cap fa-fw"></i>MOOC</a>

  </li>
        <li class="menu-item menu-item-booknotes">

    <a href="/categories/booknotes" rel="section"><i class="fa fa-book fa-fw"></i>读书笔记</a>

  </li>
        <li class="menu-item menu-item-diary">

    <a href="/categories/diary" rel="section"><i class="fa fa-keyboard fa-fw"></i>日志</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://chuanleiguo.com/2016/07/09/SwiftyJSON%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Chuanlei Guo">
      <meta itemprop="description" content="正因为未知，人与人之间的羁绊才愈发迷人">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chuan's Cabin">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          SwiftyJSON 源码阅读笔记
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-07-10 02:18:23" itemprop="dateCreated datePublished" datetime="2016-07-10T02:18:23+08:00">2016-07-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-06-21 18:55:55" itemprop="dateModified" datetime="2020-06-21T18:55:55+08:00">2020-06-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/sourcecode/" itemprop="url" rel="index"><span itemprop="name">源码分析</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2016/07/09/SwiftyJSON%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/07/09/SwiftyJSON源码阅读笔记/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>SwiftyJSON 是使用Swift编写的 JSON 解析库。Swift 是一门强类型的语言，并且引入了 Optional 类型。这使得解析 JSON 数据变得异常麻烦，我们往往需要不断地判断 Optional 中是否包含了有效值：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> jsonObject : <span class="type">AnyObject!</span> = <span class="type">NSJSONSerialization</span>.<span class="type">JSONObjectWithData</span>(dataFromTwitter, options: <span class="type">NSJSONReadingOptions</span>.<span class="type">MutableContainers</span>, error: <span class="literal">nil</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> statusesArray = jsonObject <span class="keyword">as</span>? <span class="type">NSArray</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> aStatus = statusesArray[<span class="number">0</span>] <span class="keyword">as</span>? <span class="type">NSDictionary</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> user = aStatus[<span class="string">"user"</span>] <span class="keyword">as</span>? <span class="type">NSDictionary</span>&#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> userName = user[<span class="string">"name"</span>] <span class="keyword">as</span>? <span class="type">NSDictionary</span>&#123;</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用可选链的来访问 JSON 中的数据也依然非常麻烦。</p>
<p>SwiftyJSON 很好的解决了上面的问题，使我们可以用简洁的语法访问数据，而不用担心程序崩溃。正是因为安全、高效以及极易上手的特点，它在Github获得了超过10000 Star。</p>
<p>“优秀的源代码使最好的老师”。我们来研究一下 SwiftyJSON 是怎样实现的。</p>
<h2 id="数据保存"><a href="#数据保存" class="headerlink" title="数据保存"></a>数据保存</h2><p>SwiftJSON 使用一个 Struct 来抽象表示 JSON：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">struct</span> <span class="title">JSON</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们在<a href="http://www.json.org" target="_blank" rel="noopener">json.org</a>看到，JSON 只可以存储几种简单的数据：</p>
<ol>
<li>键值对，即字典</li>
<li>数组，可以保存一系列的值</li>
<li>具体值，它可以是字符串，数字，json对象，数组，bool值，还可能是null</li>
</ol>
<p>SwiftyJSON 定义了一个枚举来抽象表示这些数据类型：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">Type</span> :<span class="title">Int</span></span>&#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="type">Number</span>      </span><br><span class="line">    <span class="keyword">case</span> <span class="type">String</span></span><br><span class="line">    <span class="keyword">case</span> <span class="type">Bool</span></span><br><span class="line">    <span class="keyword">case</span> <span class="type">Array</span></span><br><span class="line">    <span class="keyword">case</span> <span class="type">Dictionary</span></span><br><span class="line">    <span class="keyword">case</span> <span class="type">Null</span></span><br><span class="line">    <span class="keyword">case</span> <span class="type">Unknown</span>     <span class="comment">// 代表未知类型，或无法解析</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SwiftyJSON 使用一个私有变量<code>_type</code>来确定数据的类型，并使用一系列私有的变量来保存相应类型的元数据(Raw Value)。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> _type: <span class="type">Type</span> = .<span class="type">Null</span>  <span class="comment">// 初始为空类型</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> rawArray: [<span class="type">AnyObject</span>] = []</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> rawDictionary: [<span class="type">String</span> : <span class="type">AnyObject</span>] = [:]</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> rawString: <span class="type">String</span> = <span class="string">""</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> rawNumber: <span class="type">NSNumber</span> = <span class="number">0</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> rawNull: <span class="type">NSNull</span> = <span class="type">NSNull</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用私有的 _error 来存储错误</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> _error: <span class="type">NSError?</span> = <span class="literal">nil</span></span><br></pre></td></tr></table></figure>

<p>现在，可以使用一个抽象的公有变量<code>object</code>作为接口，根据<em>Type</em>枚举来设置或取得JSON相应类型的数据：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">var</span> object: <span class="type">AnyObject</span> &#123;</span><br><span class="line">    <span class="keyword">get</span> &#123;</span><br><span class="line">        <span class="comment">// 根据 _type 来取得相应的数据 </span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">set</span> &#123;</span><br><span class="line">        <span class="comment">// 根据 _type 来设置相应的数据 </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们以<code>object</code>的<code>set</code>方法为例来演示如何设置JSON的数据：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">var</span> object: <span class="type">AnyObject</span> &#123;</span><br><span class="line">    <span class="keyword">get</span> &#123;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">set</span> &#123;</span><br><span class="line">        _error = <span class="literal">nil</span></span><br><span class="line">        <span class="keyword">switch</span> newValue &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="keyword">let</span> number <span class="keyword">as</span> <span class="type">NSNumber</span>:</span><br><span class="line">                <span class="keyword">if</span> number.isBool &#123;</span><br><span class="line">                    _type = .<span class="type">Bool</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    _type = .<span class="type">Number</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">self</span>.rawNumber = number</span><br><span class="line">            <span class="keyword">case</span>  <span class="keyword">let</span> string <span class="keyword">as</span> <span class="type">String</span>:</span><br><span class="line">                _type = .<span class="type">String</span></span><br><span class="line">                <span class="keyword">self</span>.rawString = string</span><br><span class="line">            <span class="keyword">case</span>  <span class="number">_</span> <span class="keyword">as</span> <span class="type">NSNull</span>:</span><br><span class="line">                _type = .<span class="type">Null</span></span><br><span class="line">            <span class="keyword">case</span> <span class="keyword">let</span> array <span class="keyword">as</span> [<span class="type">AnyObject</span>]:</span><br><span class="line">                _type = .<span class="type">Array</span></span><br><span class="line">                <span class="keyword">self</span>.rawArray = array</span><br><span class="line">            <span class="keyword">case</span> <span class="keyword">let</span> dictionary <span class="keyword">as</span> [<span class="type">String</span> : <span class="type">AnyObject</span>]:</span><br><span class="line">                _type = .<span class="type">Dictionary</span></span><br><span class="line">                <span class="keyword">self</span>.rawDictionary = dictionary</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                _type = .<span class="type">Unknown</span></span><br><span class="line">                _error = <span class="type">NSError</span>(domain: <span class="type">ErrorDomain</span>, code: <span class="type">ErrorUnsupportedType</span>, </span><br><span class="line">                userInfo: [<span class="type">NSLocalizedDescriptionKey</span>: <span class="string">"It is a unsupported type"</span>])</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>object</code>的<code>get</code>方法也是同样使用<em>switch/case</em>语句来根据<code>_type</code>得到相应的数据。</p>
<h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><p>SwiftyJSON 提供了丰富的初始化方法：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用 NSData 来创建 JSON </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">init</span>(data: <span class="type">NSData</span>, options opt: <span class="type">NSJSONReadingOptions</span>, error: <span class="type">NSErrorPointer</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用拥有字典、数组等数据类型属性的对象来创建 JSON </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">init</span>(<span class="number">_</span> object: <span class="type">AnyObject</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 [JSON] 来初始化 JSON</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">init</span>(<span class="number">_</span> jsonArray: [<span class="type">JSON</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 [String: JSON] 来初始化 JSON</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">init</span>(<span class="number">_</span> jsonDictionary: [<span class="type">String</span>: <span class="type">JSON</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 JSON 字符串来初始化 JSON</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">parse</span><span class="params">(string: String)</span></span> -&gt; <span class="type">JSON</span></span><br></pre></td></tr></table></figure>

<p>第一个初始化方法使用<code>NSJSONSerialization</code>创建包含相应属性的 JSON 对象：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">init</span>(data:<span class="type">NSData</span>, options opt: <span class="type">NSJSONReadingOptions</span> = .<span class="type">AllowFragments</span>, error: <span class="type">NSErrorPointer</span> = <span class="literal">nil</span>) &#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> object: <span class="type">AnyObject</span> = <span class="keyword">try</span> <span class="type">NSJSONSerialization</span>.<span class="type">JSONObjectWithData</span>(data, options: opt)</span><br><span class="line">        <span class="keyword">self</span>.<span class="keyword">init</span>(object)</span><br><span class="line">    &#125; <span class="keyword">catch</span> <span class="keyword">let</span> aError <span class="keyword">as</span> <span class="type">NSError</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> error != <span class="literal">nil</span> &#123;</span><br><span class="line">            error.memory = aError</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>.<span class="keyword">init</span>(<span class="type">NSNull</span>())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过调用这个初始化方法，可以将 JSON 字符串解析为 JSON 对象。如果字符串是合法的 JSON 字符串，那么就返回相应的 JSON 对象，负责返回一个空 JSON 对象：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">parse</span><span class="params">(string: String)</span></span> -&gt; <span class="type">JSON</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> string.dataUsingEncoding(<span class="type">NSUTF8StringEncoding</span>)</span><br><span class="line">        .flatMap(&#123;<span class="type">JSON</span>(data: $<span class="number">0</span>)&#125;) ?? <span class="type">JSON</span>(<span class="type">NSNull</span>())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>剩下的三个初始化方法均是直接设置 <code>struct JSON</code> 中的 <code>object</code> 对象来完成初始化：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">init</span>(<span class="number">_</span> object: <span class="type">AnyObject</span>) &#123;</span><br><span class="line">    <span class="keyword">self</span>.object = object</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">init</span>(<span class="number">_</span> jsonArray:[<span class="type">JSON</span>]) &#123;</span><br><span class="line">    <span class="keyword">self</span>.<span class="keyword">init</span>(jsonArray.<span class="built_in">map</span> &#123; $<span class="number">0</span>.object &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">init</span>(<span class="number">_</span> jsonDictionary:[<span class="type">String</span>: <span class="type">JSON</span>]) &#123;</span><br><span class="line">    <span class="keyword">var</span> dictionary = [<span class="type">String</span>: <span class="type">AnyObject</span>](minimumCapacity: jsonDictionary.<span class="built_in">count</span>)</span><br><span class="line">    <span class="keyword">for</span> (key, json) <span class="keyword">in</span> jsonDictionary &#123;</span><br><span class="line">        dictionary[key] = json.object</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">self</span>.<span class="keyword">init</span>(dictionary)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="用字面量初始化-JSON"><a href="#用字面量初始化-JSON" class="headerlink" title="用字面量初始化 JSON"></a>用字面量初始化 JSON</h4><p>SwiftyJSON 的另外一项功能就是可以使用字面量初始化 <code>struct JSON</code>：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// StringLiteralConvertible</span></span><br><span class="line"><span class="keyword">let</span> json: <span class="type">JSON</span> = <span class="string">"I'm a json"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// IntegerLiteralConvertible</span></span><br><span class="line"><span class="keyword">let</span> json: <span class="type">JSON</span> =  <span class="number">12345</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// FloatLiteralConvertible</span></span><br><span class="line"><span class="keyword">let</span> json: <span class="type">JSON</span> =  <span class="number">2.8765</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// With subscript in array</span></span><br><span class="line"><span class="keyword">var</span> json: <span class="type">JSON</span> =  [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// With subscript in dictionary</span></span><br><span class="line"><span class="keyword">var</span> json: <span class="type">JSON</span> =  [<span class="string">"name"</span>: <span class="string">"Jack"</span>, <span class="string">"age"</span>: <span class="number">25</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// Array &amp; Dictionary</span></span><br><span class="line"><span class="keyword">var</span> json: <span class="type">JSON</span> =  [<span class="string">"name"</span>: <span class="string">"Jack"</span>, <span class="string">"age"</span>: <span class="number">25</span>, <span class="string">"list"</span>: [<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>, [<span class="string">"what"</span>: <span class="string">"this"</span>]]]</span><br></pre></td></tr></table></figure>

<p>这个功能的实现很直接，就是根据<a href="http://nshipster.com/swift-literal-convertible/" target="_blank" rel="noopener">Swift Literal Convertibles</a>遵循一系列协议：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">JSON</span>: <span class="title">StringLiteralConvertible</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">JSON</span>: <span class="title">IntegerLiteralConvertible</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">JSON</span>: <span class="title">BooleanLiteralConvertible</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">JSON</span>: <span class="title">FloatLiteralConvertible</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">JSON</span>: <span class="title">DictionaryLiteralConvertible</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">JSON</span>: <span class="title">ArrayLiteralConvertible</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">JSON</span>: <span class="title">NilLiteralConvertible</span> </span>&#123; ... &#125;</span><br></pre></td></tr></table></figure>

<p>综上，SwiftyJSON 在初始化以后得到的是一个多个保存不同类型数据的 JSON 对象相互嵌套的模型：</p>
<p><img src="/images/2016-7-10/image.001.jpeg" alt="image.001"></p>
<h2 id="解析-JSON"><a href="#解析-JSON" class="headerlink" title="解析 JSON"></a>解析 JSON</h2><h3 id="下标"><a href="#下标" class="headerlink" title="下标"></a>下标</h3><p>在 SwiftyJSON 中的<code>struct JSON</code>保存的可能是字典，数组，或者是具体的值，如：字符串，数字。当保存的是字典或数组时，我们需要使用分别使用字符串和数字作为下标来访问其中的数据。为了可以同时使用字符串和数字作为下标，SwiftyJSON 定义了一个协议 <code>JSONSubscriptType</code> 来代表 <code>struct JSON</code> 的下标，并定义枚举类型 <code>JSONKey</code> 来区分字符串和数组。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">JSONKey</span> </span>&#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="type">Index</span>(<span class="type">Int</span>)</span><br><span class="line">    <span class="keyword">case</span> <span class="type">Key</span>(<span class="type">String</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">protocol</span> <span class="title">JSONSubscriptType</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> jsonKey:<span class="type">JSONKey</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Int</span>: <span class="title">JSONSubscriptType</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> jsonKey:<span class="type">JSONKey</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">JSONKey</span>.<span class="type">Index</span>(<span class="keyword">self</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">String</span>: <span class="title">JSONSubscriptType</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> jsonKey:<span class="type">JSONKey</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">JSONKey</span>.<span class="type">Key</span>(<span class="keyword">self</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在使得字符串和整数均遵循 <code>JSONSubscriptType</code> 协议后，我们就可以同时使用这两种类型作为下标来访问数据了。SwiftyJSON 也在拓展中定义了两个下标方法，它们分别接受整数和字符串作为参数来访问数据：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">JSON</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">subscript</span>(index index: <span class="type">Int</span>) -&gt; <span class="type">JSON</span> &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">self</span>.type != .<span class="type">Array</span> &#123;</span><br><span class="line">                <span class="keyword">var</span> r = <span class="type">JSON</span>.null</span><br><span class="line">                r._error = <span class="keyword">self</span>._error ?? <span class="type">NSError</span>(domain: <span class="type">ErrorDomain</span>, code: <span class="type">ErrorWrongType</span>, userInfo: [<span class="type">NSLocalizedDescriptionKey</span>: <span class="string">"Array[\(index)] failure, It is not an array"</span>])</span><br><span class="line">                <span class="keyword">return</span> r</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> index &gt;= <span class="number">0</span> &amp;&amp; index &lt; <span class="keyword">self</span>.rawArray.<span class="built_in">count</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="type">JSON</span>(<span class="keyword">self</span>.rawArray[index])</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">var</span> r = <span class="type">JSON</span>.null</span><br><span class="line">                r._error = <span class="type">NSError</span>(domain: <span class="type">ErrorDomain</span>, code:<span class="type">ErrorIndexOutOfBounds</span> , userInfo: [<span class="type">NSLocalizedDescriptionKey</span>: <span class="string">"Array[\(index)] is out of bounds"</span>])</span><br><span class="line">                <span class="keyword">return</span> r</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">self</span>.type == .<span class="type">Array</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">self</span>.rawArray.<span class="built_in">count</span> &gt; index &amp;&amp; newValue.error == <span class="literal">nil</span> &#123;</span><br><span class="line">                    <span class="keyword">self</span>.rawArray[index] = newValue.object</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">subscript</span>(key key: <span class="type">String</span>) -&gt; <span class="type">JSON</span> &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> r = <span class="type">JSON</span>.null</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">self</span>.type == .<span class="type">Dictionary</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">let</span> o = <span class="keyword">self</span>.rawDictionary[key] &#123;</span><br><span class="line">                    r = <span class="type">JSON</span>(o)</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    r._error = <span class="type">NSError</span>(domain: <span class="type">ErrorDomain</span>, code: <span class="type">ErrorNotExist</span>, userInfo: [<span class="type">NSLocalizedDescriptionKey</span>: <span class="string">"Dictionary[\"\(key)\"] does not exist"</span>])</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                r._error = <span class="keyword">self</span>._error ?? <span class="type">NSError</span>(domain: <span class="type">ErrorDomain</span>, code: <span class="type">ErrorWrongType</span>, userInfo: [<span class="type">NSLocalizedDescriptionKey</span>: <span class="string">"Dictionary[\"\(key)\"] failure, It is not an dictionary"</span>])</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> r</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">self</span>.type == .<span class="type">Dictionary</span> &amp;&amp; newValue.error == <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">self</span>.rawDictionary[key] = newValue.object</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这两个私有方法分别使用整数和字符串作为参数来访问数据。在函数内部的访问逻辑中，它们分别判断了类型错误，整数下标是否越界，字符串下标是否存在等错误，完善得处理了在获得 JSON 数据过程中可能出现的错误。</p>
<p>SwiftyJSON 还定义了一个私有的下标方法来优雅地简化了对上述两个方法的调用：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">subscript</span>(sub sub: <span class="type">JSONSubscriptType</span>) -&gt; <span class="type">JSON</span> &#123;</span><br><span class="line">    <span class="keyword">get</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> sub.jsonKey &#123;</span><br><span class="line">        <span class="keyword">case</span> .<span class="type">Index</span>(<span class="keyword">let</span> index): <span class="keyword">return</span> <span class="keyword">self</span>[index: index]</span><br><span class="line">        <span class="keyword">case</span> .<span class="type">Key</span>(<span class="keyword">let</span> key): <span class="keyword">return</span> <span class="keyword">self</span>[key: key]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">set</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> sub.jsonKey &#123;</span><br><span class="line">        <span class="keyword">case</span> .<span class="type">Index</span>(<span class="keyword">let</span> index): <span class="keyword">self</span>[index: index] = newValue</span><br><span class="line">        <span class="keyword">case</span> .<span class="type">Key</span>(<span class="keyword">let</span> key): <span class="keyword">self</span>[key: key] = newValue</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个私有的下标方法给提供的一个简单的内部接口，它判断下标的类型，从而在内部调用的时候可以不用关心下标的具体类型。</p>
<p>在以上三个私有方法的基础上，SwiftyJSON 定义了两个接口，使得我们可以用非常简单的语法来安全地访问数据：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">subscript</span>(path: [<span class="type">JSONSubscriptType</span>]) -&gt; <span class="type">JSON</span> &#123;</span><br><span class="line">    <span class="keyword">get</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> path.<span class="built_in">reduce</span>(<span class="keyword">self</span>) &#123; $<span class="number">0</span>[sub: $<span class="number">1</span>] &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">set</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> path.<span class="built_in">count</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">self</span>[sub:path[<span class="number">0</span>]].object = newValue.object</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">var</span> aPath = path; aPath.removeAtIndex(<span class="number">0</span>)</span><br><span class="line">            <span class="keyword">var</span> nextJSON = <span class="keyword">self</span>[sub: path[<span class="number">0</span>]]</span><br><span class="line">            nextJSON[aPath] = newValue</span><br><span class="line">            <span class="keyword">self</span>[sub: path[<span class="number">0</span>]] = nextJSON</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">subscript</span>(path: <span class="type">JSONSubscriptType</span>...) -&gt; <span class="type">JSON</span> &#123;</span><br><span class="line">    <span class="keyword">get</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>[path]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">set</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>[path] = newValue</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这两个函数巧妙得使用了函数式编程的技巧，如<code>path.reduce(self) { $0[sub: $1] }</code>，使代码简洁易读，这也正是使用 Swift 写出的代码应该具备的特点：安全、简洁、高效。</p>
<p>使用这两个方法，我们可以这样得到 JSON 对象中的数据：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> name = json[<span class="number">9</span>][<span class="string">"list"</span>][<span class="string">"person"</span>][<span class="string">"name"</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> sameName = json[<span class="number">9</span>,<span class="string">"list"</span>,<span class="string">"person"</span>,<span class="string">"name"</span>]</span><br></pre></td></tr></table></figure>

<p>这比起文章开头的例子，是不是简单、易读了太多呢？</p>
<h3 id="安全地访问数据"><a href="#安全地访问数据" class="headerlink" title="安全地访问数据"></a>安全地访问数据</h3><p>SwiftyJSON 使用两种不同命名的只读计算变量来使我们可以根据自己的需要安全得访问数据。只读计算变量的命名遵循以下规则：</p>
<ol>
<li><code>type</code> —— 返回包含该类型的可选值，当数据错误时返回nil</li>
<li><code>typeValue</code> —— 返回具体的值，当数据错误时返回具体类型的默认值，如[], 0等。</li>
</ol>
<p>所以要得到 JSON 数组或字典，我们可以使用以下接口：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MARK: - Array</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">JSON</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> array: [<span class="type">JSON</span>]? &#123; <span class="keyword">get</span> &#125;     <span class="comment">// 返回 Optional([JSON])</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> arrayValue: [<span class="type">JSON</span>] &#123; <span class="keyword">get</span> &#125; <span class="comment">// 返回 [JSON]</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MARK: - Dictionary</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">JSON</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> dictionary: [<span class="type">String</span>: <span class="type">JSON</span>]? &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> dictionaryValue: [<span class="type">String</span>: <span class="type">JSON</span>] &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>要得到数组和字典中的元素，SwiftyJSON 也定义了相应的接口，它们均是计算属性，通过访问内部的数据结构来获取或设置数据：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MARK: - Array</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">JSON</span> </span>&#123;</span><br><span class="line">    <span class="comment">//Optional [AnyObject]</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> arrayObject: [<span class="type">AnyObject</span>]? &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123;</span><br><span class="line">            <span class="keyword">switch</span> <span class="keyword">self</span>.type &#123;</span><br><span class="line">            <span class="keyword">case</span> .<span class="type">Array</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">self</span>.rawArray</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> array = newValue &#123;</span><br><span class="line">                <span class="keyword">self</span>.object = array</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">self</span>.object = <span class="type">NSNull</span>()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MARK: - Dictionary</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">JSON</span> </span>&#123;</span><br><span class="line">    <span class="comment">//Optional [String : AnyObject]</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> dictionaryObject: [<span class="type">String</span> : <span class="type">AnyObject</span>]? &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123;</span><br><span class="line">            <span class="keyword">switch</span> <span class="keyword">self</span>.type &#123;</span><br><span class="line">            <span class="keyword">case</span> .<span class="type">Dictionary</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">self</span>.rawDictionary</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> v = newValue &#123;</span><br><span class="line">                <span class="keyword">self</span>.object = v</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">self</span>.object = <span class="type">NSNull</span>()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SwiftyJSON 中 <code>struct JSON</code> 内部使用<em>NSNumber</em>类型的<code>rawNumber</code>来保存bool和数字，所以SwiftyJSON 定义了返回<em>NSNumber</em>的接口，也可以通过这个接口来得到相应类型的数字，如：Int, Double, Float, Int8, Int16, Int32, Int64等。</p>
<p>特别注意一点，因为 JSON 本质上是一个文本文件，它的内容均是字符串。所以在我们要获得数字的时候，要将用字符串表示的数字，如“123”，转化为<em>NSNumber</em>。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MARK: - Number</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">JSON</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Optional number</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> number: <span class="type">NSNumber?</span> &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123;</span><br><span class="line">            <span class="keyword">switch</span> <span class="keyword">self</span>.type &#123;</span><br><span class="line">            <span class="keyword">case</span> .<span class="type">Number</span>, .<span class="type">Bool</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">self</span>.rawNumber</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.object = newValue ?? <span class="type">NSNull</span>()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Non-optional number</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> numberValue: <span class="type">NSNumber</span> &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123;</span><br><span class="line">            <span class="keyword">switch</span> <span class="keyword">self</span>.type &#123;</span><br><span class="line">            <span class="keyword">case</span> .<span class="type">String</span>:</span><br><span class="line">                <span class="keyword">let</span> decimal = <span class="type">NSDecimalNumber</span>(string: <span class="keyword">self</span>.object <span class="keyword">as</span>? <span class="type">String</span>)</span><br><span class="line">                <span class="keyword">if</span> decimal == <span class="type">NSDecimalNumber</span>.notANumber() &#123;  <span class="comment">// indicates parse error</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="type">NSDecimalNumber</span>.zero()</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> decimal</span><br><span class="line">            <span class="keyword">case</span> .<span class="type">Number</span>, .<span class="type">Bool</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">self</span>.object <span class="keyword">as</span>? <span class="type">NSNumber</span> ?? <span class="type">NSNumber</span>(int: <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="type">NSNumber</span>(double: <span class="number">0.0</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.object = newValue</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之后，SwiftJSON 使用<code>public var number</code>和<code>public var numberValue</code>这两个接口在得到各种数字类型，以<em>Double</em>为例：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">JSON</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> double: <span class="type">Double?</span> &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">self</span>.number?.double</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> newValue = newValue &#123;</span><br><span class="line">                <span class="keyword">self</span>.object = <span class="type">NSNumber</span>(double: newValue)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">self</span>.object = <span class="type">NSNull</span>()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> doubleValue: <span class="type">Double</span> &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">self</span>.numberValue.doubleValue</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">set</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.object = <span class="type">NSNumber</span>(double: newValue)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>获得其它类型数字的接口的实现方法和这段代码类似。</p>
<p>此外，SwiftyJSON 也定义了我们非常常用的返回URL的接口，它返回一个Optional：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MARK: - URL</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">JSON</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> <span class="type">URL</span>: <span class="type">NSURL?</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用-Raw-Value"><a href="#使用-Raw-Value" class="headerlink" title="使用 Raw Value"></a>使用 Raw Value</h3><p>除了使用解析后的具体的值以外，SwiftyJSON 通过遵循<em>RawRepresentable</em>协议，来允许我们直接使用元数据(Raw Value)。我们可以选择直接使用 JSON 对象：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">JSON</span>: <span class="title">RawRepresentable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">init</span>?(rawValue: <span class="type">AnyObject</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="type">JSON</span>(rawValue).type == .<span class="type">Unknown</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.<span class="keyword">init</span>(rawValue)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> rawValue: <span class="type">AnyObject</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.object</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以直接将 JSON 对象转化为NSData:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">JSON</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">rawData</span><span class="params">(options opt: NSJSONWritingOptions = NSJSONWritingOptions<span class="params">(rawValue: <span class="number">0</span>)</span></span></span>) <span class="keyword">throws</span> -&gt; <span class="type">NSData</span> &#123;</span><br><span class="line">        <span class="keyword">guard</span> <span class="type">NSJSONSerialization</span>.isValidJSONObject(<span class="keyword">self</span>.object) <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="type">NSError</span>(domain: <span class="type">ErrorDomain</span>, code: <span class="type">ErrorInvalidJSON</span>, userInfo: [<span class="type">NSLocalizedDescriptionKey</span>: <span class="string">"JSON is invalid"</span>])</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">try</span> <span class="type">NSJSONSerialization</span>.dataWithJSONObject(<span class="keyword">self</span>.object, options: opt)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 我们可以简单地将 JSON 对象转化为 NSData</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> data = json.rawData() &#123;</span><br><span class="line">    <span class="comment">//Do something you want</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也可以把 JSON 对象转化为字符串：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">JSON</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">rawString</span><span class="params">(encoding: UInt = NSUTF8StringEncoding, options opt: NSJSONWritingOptions = .PrettyPrinted)</span></span> -&gt; <span class="type">String?</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> <span class="keyword">self</span>.type &#123;</span><br><span class="line">        <span class="keyword">case</span> .<span class="type">Array</span>, .<span class="type">Dictionary</span>:</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> data = <span class="keyword">try</span> <span class="keyword">self</span>.rawData(options: opt)</span><br><span class="line">                <span class="keyword">return</span> <span class="type">NSString</span>(data: data, encoding: encoding) <span class="keyword">as</span>? <span class="type">String</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> <span class="number">_</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">case</span> .<span class="type">String</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">self</span>.rawString</span><br><span class="line">        <span class="keyword">case</span> .<span class="type">Number</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">self</span>.rawNumber.stringValue</span><br><span class="line">        <span class="keyword">case</span> .<span class="type">Bool</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">self</span>.rawNumber.boolValue.description</span><br><span class="line">        <span class="keyword">case</span> .<span class="type">Null</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"null"</span></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 我们可以简单地将 JSON 对象转化为 String</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> string = json.rawString() &#123;</span><br><span class="line">    <span class="comment">//Do something you want</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SwiftyJSON 也让 <code>struct JSON</code> 遵循了<em>Printable</em>和<em>DebugPrintable</em>协议，使我们可以直接以字符串的形式输出JSON:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">JSON</span>: <span class="title">Printable</span>, <span class="title">DebugPrintable</span> </span>&#123; ... &#125;</span><br></pre></td></tr></table></figure>

<h2 id="遍历-JSON"><a href="#遍历-JSON" class="headerlink" title="遍历 JSON"></a>遍历 JSON</h2><p>在 SwiftyJSON 的<a href="https://github.com/SwiftyJSON/SwiftyJSON/blob/master/README.md" target="_blank" rel="noopener">介绍</a>中，描写了对 JSON 的遍历功能：</p>
<blockquote>
<p>如果 JSON 是 Dictionary</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (key: subJson): (<span class="type">String</span>: <span class="type">JSON</span>) <span class="keyword">in</span> <span class="type">JSON</span> &#123;</span><br><span class="line">    <span class="comment">// 其中 key 就是字典中的键</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果 JSON 是 Array</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (index, json): (<span class="type">String</span>: <span class="type">JSON</span>) <span class="keyword">in</span> <span class="type">JSON</span> &#123;</span><br><span class="line">    <span class="comment">// 其中 key 就是字符串类型的 o..&lt;json.count 的值</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</blockquote>
<p>要使得 <code>struct JSON</code> 可以在<em>for…in</em>循环中被多次遍历，就需要让 <code>struct JSON</code> 遵从<em>CollectionType</em>协议。 </p>
<h3 id="遵循-CollectionType-协议"><a href="#遵循-CollectionType-协议" class="headerlink" title="遵循 CollectionType 协议"></a>遵循 CollectionType 协议</h3><p>首先，SwiftyJSON 定义了遵循<em>CollectionType</em>协议所需要的两个关联类型，它们分别代表了集合中的元素的生成器、访问集合元素时所要使用的下标类型，以及遍历时生成下一个元素的生成器:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">JSON</span>: <span class="title">CollectionType</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">typealias</span> <span class="type">Generator</span> = <span class="type">JSONGenerator</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">typealias</span> <span class="type">Index</span> = <span class="type">JSONIndex</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">generate</span><span class="params">()</span></span> -&gt; <span class="type">JSON</span>.<span class="type">Generator</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">JSON</span>.<span class="type">Generator</span>(<span class="keyword">self</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之后，实现了返回起始和结尾索引、根据索引返回相应元素的接口，并根据需要重写了默认的方法。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">JSON</span>: <span class="title">CollectionType</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> startIndex: <span class="type">JSON</span>.<span class="type">Index</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> <span class="keyword">self</span>.type &#123;</span><br><span class="line">        <span class="keyword">case</span> .<span class="type">Array</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="type">JSONIndex</span>(arrayIndex: <span class="keyword">self</span>.rawArray.startIndex)</span><br><span class="line">        <span class="keyword">case</span> .<span class="type">Dictionary</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="type">JSONIndex</span>(dictionaryIndex: <span class="keyword">self</span>.rawDictionary.startIndex)</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="type">JSONIndex</span>()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> endIndex: <span class="type">JSON</span>.<span class="type">Index</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> <span class="keyword">self</span>.type &#123;</span><br><span class="line">        <span class="keyword">case</span> .<span class="type">Array</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="type">JSONIndex</span>(arrayIndex: <span class="keyword">self</span>.rawArray.endIndex)</span><br><span class="line">        <span class="keyword">case</span> .<span class="type">Dictionary</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="type">JSONIndex</span>(dictionaryIndex: <span class="keyword">self</span>.rawDictionary.endIndex)</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="type">JSONIndex</span>()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">subscript</span> (position: <span class="type">JSON</span>.<span class="type">Index</span>) -&gt; <span class="type">JSON</span>.<span class="type">Generator</span>.<span class="type">Element</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> <span class="keyword">self</span>.type &#123;</span><br><span class="line">        <span class="keyword">case</span> .<span class="type">Array</span>:</span><br><span class="line">            <span class="keyword">return</span> (<span class="type">String</span>(position.arrayIndex), <span class="type">JSON</span>(<span class="keyword">self</span>.rawArray[position.arrayIndex!]))</span><br><span class="line">        <span class="keyword">case</span> .<span class="type">Dictionary</span>:</span><br><span class="line">            <span class="keyword">let</span> (key, value) = <span class="keyword">self</span>.rawDictionary[position.dictionaryIndex!]</span><br><span class="line">            <span class="keyword">return</span> (key, <span class="type">JSON</span>(value))</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> (<span class="string">""</span>, <span class="type">JSON</span>.null)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> isEmpty: <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123;</span><br><span class="line">            <span class="keyword">switch</span> <span class="keyword">self</span>.type &#123;</span><br><span class="line">            <span class="keyword">case</span> .<span class="type">Array</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">self</span>.rawArray.isEmpty</span><br><span class="line">            <span class="keyword">case</span> .<span class="type">Dictionary</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">self</span>.rawDictionary.isEmpty</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> <span class="built_in">count</span>: <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> <span class="keyword">self</span>.type &#123;</span><br><span class="line">        <span class="keyword">case</span> .<span class="type">Array</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">self</span>.rawArray.<span class="built_in">count</span></span><br><span class="line">        <span class="keyword">case</span> .<span class="type">Dictionary</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">self</span>.rawDictionary.<span class="built_in">count</span></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">underestimateCount</span><span class="params">()</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> <span class="keyword">self</span>.type &#123;</span><br><span class="line">        <span class="keyword">case</span> .<span class="type">Array</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">self</span>.rawArray.<span class="built_in">underestimateCount</span>()</span><br><span class="line">        <span class="keyword">case</span> .<span class="type">Dictionary</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">self</span>.rawDictionary.<span class="built_in">underestimateCount</span>()</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当 JSON 中保存的对象是数组或字典是，要分别使用整数和字符串作为索引来访问相应的值。所以在接口的实现中，根据索引的类型来访问相应的数据结构。</p>
<blockquote>
<p>因为 Swift 是一门多范式的“面向协议”的编程语言。在 Protocol Extension 的帮助下，我们不需要实现协议的所有方法。仅仅需要覆盖少数方法即可。其它的方法可以直接使用默认实现。</p>
</blockquote>
<h4 id="实现-JSONGenerator"><a href="#实现-JSONGenerator" class="headerlink" title="实现 JSONGenerator"></a>实现 JSONGenerator</h4><p>在使 <code>struct JSON</code> 遵循<em>CollectionType*的时候，需要使用一个元素生成器。SwiftyJSON 定义了一个 *JSONGenerator</em> 类型的生成器。它的元素类型为<code>(String, JSON)</code>，即一个tuple。这个tuple的第一个值用字符串表示元素在集合中的索引；第二个值则是<code>struct JSON</code>，这也使我们可以在遍历过程中方便地访问数据。</p>
<p>因为在 JSON 中可以遍历数组或字典，所以<em>JSONGenerator<em>中使用了标准库中的</em>IndexingGenerator</em>, <em>DictionaryGenerator</em>两个生成器来分别生成数组或字典元素，并使用一个私有变量<code>type</code>来对生成的元素的类型加以区分。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">struct</span> <span class="title">JSONGenerator</span>: <span class="title">GeneratorType</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 生成元素的类型为(String, JSON)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">typealias</span> <span class="type">Element</span> = (<span class="type">String</span>, <span class="type">JSON</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">let</span> type: <span class="type">Type</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> dictionayGenerate: <span class="type">DictionaryGenerator</span>&lt;<span class="type">String</span>, <span class="type">AnyObject</span>&gt;?</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> arrayGenerate: <span class="type">IndexingGenerator</span>&lt;[<span class="type">AnyObject</span>]&gt;?</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> arrayIndex: <span class="type">Int</span> = <span class="number">0</span>      <span class="comment">// 当生成器生成数组元素时，保存数组索引</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(<span class="number">_</span> json: <span class="type">JSON</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.type = json.type</span><br><span class="line">        <span class="keyword">if</span> type == .<span class="type">Array</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.arrayGenerate = json.rawArray.generate()</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.dictionayGenerate = json.rawDictionary.generate()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>要实现一个生成器非常简单，仅仅需要实现一个<em>next</em>方法即可：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">next</span><span class="params">()</span></span> -&gt; <span class="type">JSONGenerator</span>.<span class="type">Element?</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> <span class="keyword">self</span>.type &#123;</span><br><span class="line">    <span class="keyword">case</span> .<span class="type">Array</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> o = <span class="keyword">self</span>.arrayGenerate?.next() &#123;</span><br><span class="line">            <span class="keyword">let</span> i = <span class="keyword">self</span>.arrayIndex</span><br><span class="line">            <span class="keyword">self</span>.arrayIndex += <span class="number">1</span></span><br><span class="line">            <span class="keyword">return</span> (<span class="type">String</span>(i), <span class="type">JSON</span>(o))</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">case</span> .<span class="type">Dictionary</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> (k, v): (<span class="type">String</span>, <span class="type">AnyObject</span>) = <span class="keyword">self</span>.dictionayGenerate?.next() &#123;</span><br><span class="line">            <span class="keyword">return</span> (k, <span class="type">JSON</span>(v))</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个方法会根据<code>type</code>来分别调用相应的生成器来生成数组或字典元素。</p>
<h4 id="实现-JSONIndex"><a href="#实现-JSONIndex" class="headerlink" title="实现 JSONIndex"></a>实现 JSONIndex</h4><p>在遍历 <code>struct JSON</code> 的过程中，我们需要使用索引来访问相应的元素。因为我们所遍历的可能时数组或字典，所以在<em>JSONIndex</em>中，分别声明了两个变量<code>arrayIndex</code>和<code>dictionaryIndex</code>来作为索引，并使用一个私有变量 <code>type</code> 来区分：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">struct</span> <span class="title">JSONIndex</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> arrayIndex: <span class="type">Int?</span></span><br><span class="line">    <span class="keyword">let</span> dictionaryIndex: <span class="type">DictionaryIndex</span>&lt;<span class="type">String</span>, <span class="type">AnyObject</span>&gt;?</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> type: <span class="type">Type</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span>()&#123;</span><br><span class="line">        <span class="keyword">self</span>.arrayIndex = <span class="literal">nil</span></span><br><span class="line">        <span class="keyword">self</span>.dictionaryIndex = <span class="literal">nil</span></span><br><span class="line">        <span class="keyword">self</span>.type = .<span class="type">Unknown</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span>(arrayIndex: <span class="type">Int</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.arrayIndex = arrayIndex</span><br><span class="line">        <span class="keyword">self</span>.dictionaryIndex = <span class="literal">nil</span></span><br><span class="line">        <span class="keyword">self</span>.type = .<span class="type">Array</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span>(dictionaryIndex: <span class="type">DictionaryIndex</span>&lt;<span class="type">String</span>, <span class="type">AnyObject</span>&gt;) &#123;</span><br><span class="line">        <span class="keyword">self</span>.arrayIndex = <span class="literal">nil</span></span><br><span class="line">        <span class="keyword">self</span>.dictionaryIndex = dictionaryIndex</span><br><span class="line">        <span class="keyword">self</span>.type = .<span class="type">Dictionary</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>要使得<em>JSONIndex</em>可以在集合中作为索引使用，它必须遵循<em>ForwardIndexType</em>协议，并实现协议中的<code>successor</code>方法：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">JSONIndex</span>: <span class="title">ForwardIndexType</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">successor</span><span class="params">()</span></span> -&gt; <span class="type">JSONIndex</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> <span class="keyword">self</span>.type &#123;</span><br><span class="line">        <span class="keyword">case</span> .<span class="type">Array</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="type">JSONIndex</span>(arrayIndex: <span class="keyword">self</span>.arrayIndex!.successor())</span><br><span class="line">        <span class="keyword">case</span> .<span class="type">Dictionary</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="type">JSONIndex</span>(dictionaryIndex: <span class="keyword">self</span>.dictionaryIndex!.successor())</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="type">JSONIndex</span>()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这个实现中，根据遍历数据结构类型的不同，而返回不同类型的索引。</p>
<p>我们需要知道两个<em>JSONIndex</em>是否相等，或得到两个索引的大小关系，所以<em>JSONIndex</em>遵循了<em>Equatable</em>和<em>Comparable</em>协议：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">JSONIndex</span>: <span class="title">Equatable</span>, <span class="title">Comparable</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> ==<span class="params">(lhs: JSONIndex, rhs: JSONIndex)</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (lhs.type, rhs.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> (.<span class="type">Array</span>, .<span class="type">Array</span>):</span><br><span class="line">        <span class="keyword">return</span> lhs.arrayIndex == rhs.arrayIndex</span><br><span class="line">    <span class="keyword">case</span> (.<span class="type">Dictionary</span>, .<span class="type">Dictionary</span>):</span><br><span class="line">        <span class="keyword">return</span> lhs.dictionaryIndex == rhs.dictionaryIndex</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> &lt;(lhs: JSONIndex, rhs: JSONIndex) -&gt; <span class="title">Bool</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (lhs.type, rhs.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> (.<span class="type">Array</span>, .<span class="type">Array</span>):</span><br><span class="line">        <span class="keyword">return</span> lhs.arrayIndex &lt; rhs.arrayIndex</span><br><span class="line">    <span class="keyword">case</span> (.<span class="type">Dictionary</span>, .<span class="type">Dictionary</span>):</span><br><span class="line">        <span class="keyword">return</span> lhs.dictionaryIndex &lt; rhs.dictionaryIndex</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> &lt;=(lhs: JSONIndex, rhs: JSONIndex) -&gt; <span class="title">Bool</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (lhs.type, rhs.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> (.<span class="type">Array</span>, .<span class="type">Array</span>):</span><br><span class="line">        <span class="keyword">return</span> lhs.arrayIndex &lt;= rhs.arrayIndex</span><br><span class="line">    <span class="keyword">case</span> (.<span class="type">Dictionary</span>, .<span class="type">Dictionary</span>):</span><br><span class="line">        <span class="keyword">return</span> lhs.dictionaryIndex &lt;= rhs.dictionaryIndex</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> &gt;=<span class="params">(lhs: JSONIndex, rhs: JSONIndex)</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (lhs.type, rhs.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> (.<span class="type">Array</span>, .<span class="type">Array</span>):</span><br><span class="line">        <span class="keyword">return</span> lhs.arrayIndex &gt;= rhs.arrayIndex</span><br><span class="line">    <span class="keyword">case</span> (.<span class="type">Dictionary</span>, .<span class="type">Dictionary</span>):</span><br><span class="line">        <span class="keyword">return</span> lhs.dictionaryIndex &gt;= rhs.dictionaryIndex</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> &gt;<span class="params">(lhs: JSONIndex, rhs: JSONIndex)</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (lhs.type, rhs.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> (.<span class="type">Array</span>, .<span class="type">Array</span>):</span><br><span class="line">        <span class="keyword">return</span> lhs.arrayIndex &gt; rhs.arrayIndex</span><br><span class="line">    <span class="keyword">case</span> (.<span class="type">Dictionary</span>, .<span class="type">Dictionary</span>):</span><br><span class="line">        <span class="keyword">return</span> lhs.dictionaryIndex &gt; rhs.dictionaryIndex</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="源码学习体会"><a href="#源码学习体会" class="headerlink" title="源码学习体会"></a>源码学习体会</h2><p>我从2014年6月，Apple在WWDC上公布Swift起就开始关注这门现代的编程语言，关注它的每一个变化，尝试用Swift来解决问题，开发App，并享受编程了乐趣。</p>
<p>可惜由于编程能力欠佳，我对这门语言的理解依然有限，使用Swift编写出的代码仍然浓浓的Objective-C的味道。可以说自己是在使用Swift的语法来编写Objective-C。</p>
<p>通过对 SwiftyJSON 这样的优秀的开源代码的学习，我学到了很多。</p>
<ol>
<li>我学会了要在在恰当地使用函数式编程，这样写出的代码简洁、高效并且有良好的可读性，SwiftyJSON 中实现<em>DictionaryLiteralConvertible</em>、实现<code>let name = json[9][&quot;list&quot;][&quot;person&quot;][&quot;name&quot;]</code>访问数据等都是出色的实践。</li>
<li>对SwiftyJSON 代码的分析也加深了我对 Swift “面向协议编程”、“从协议出发编程”，值语义等概念的理解；</li>
</ol>
<p>在今后的实践中，我也要有意识得运用这些编程技巧，写出更加Swifty的代码，更合理、高效地解决编程中遇到的问题。</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/swift/" rel="tag"># swift</a>
              <a href="/tags/sourcecode/" rel="tag"># sourcecode</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item"></div>
      <div class="post-nav-item">
    <a href="/2016/08/09/%E5%AF%8C%E7%88%B8%E7%88%B8%E7%A9%B7%E7%88%B8%E7%88%B8%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" rel="next" title="《富爸爸 穷爸爸》读书笔记">
      《富爸爸 穷爸爸》读书笔记 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#数据保存"><span class="nav-number">1.</span> <span class="nav-text">数据保存</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#初始化"><span class="nav-number">1.1.</span> <span class="nav-text">初始化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#用字面量初始化-JSON"><span class="nav-number">1.1.1.</span> <span class="nav-text">用字面量初始化 JSON</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#解析-JSON"><span class="nav-number">2.</span> <span class="nav-text">解析 JSON</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#下标"><span class="nav-number">2.1.</span> <span class="nav-text">下标</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安全地访问数据"><span class="nav-number">2.2.</span> <span class="nav-text">安全地访问数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用-Raw-Value"><span class="nav-number">2.3.</span> <span class="nav-text">使用 Raw Value</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#遍历-JSON"><span class="nav-number">3.</span> <span class="nav-text">遍历 JSON</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#遵循-CollectionType-协议"><span class="nav-number">3.1.</span> <span class="nav-text">遵循 CollectionType 协议</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#实现-JSONGenerator"><span class="nav-number">3.1.1.</span> <span class="nav-text">实现 JSONGenerator</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#实现-JSONIndex"><span class="nav-number">3.1.2.</span> <span class="nav-text">实现 JSONIndex</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#源码学习体会"><span class="nav-number">4.</span> <span class="nav-text">源码学习体会</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Chuanlei Guo</p>
  <div class="site-description" itemprop="description">正因为未知，人与人之间的羁绊才愈发迷人</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">23</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">24</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/ChuanleiGuo" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ChuanleiGuo" rel="noopener" target="_blank"><i class="github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:chuanleiguo@gmail.com" title="E-Mail → mailto:chuanleiguo@gmail.com" rel="noopener" target="_blank"><i class="envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://weibo.com/bestchuan" title="Weibo → http:&#x2F;&#x2F;weibo.com&#x2F;bestchuan" rel="noopener" target="_blank"><i class="weibo fa-fw"></i>Weibo</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2016 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Chuanlei Guo</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://chuanleiguo-com.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  var disqus_config = function() {
    this.page.url = "http://chuanleiguo.com/2016/07/09/SwiftyJSON%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/";
    this.page.identifier = "2016/07/09/SwiftyJSON源码阅读笔记/";
    this.page.title = "SwiftyJSON 源码阅读笔记";
    };
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: disqus_config
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://chuanleiguo-com.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>

</body>
</html>
